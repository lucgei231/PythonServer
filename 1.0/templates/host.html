<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>QuizFabric - Host: {{ quiz_name }}</title>
    <link rel="icon" href="/data/icon.png" type="image/png">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel="apple-touch-icon" href="/data/icon.png">
    <meta name="theme-color" content="#4f46e5">
    <meta name="description" content="A modern quiz application for creating and taking quizzes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="QuizFabric">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        .app-icon {
            position: fixed;
            top: 10px;
            right: 10px;
            height: 40px;
            width: 40px;
            z-index: 1000;
            opacity: 0.9;
        }
        .host-container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        .game-code {
            font-size: 1.5em;
            font-weight: bold;
            color: #007bff;
        }
        .player-list {
            margin: 20px 0;
        }
        .btn-container {
            margin: 20px 0;
        }
        #player-list-container.hidden {
            display: none !important;
        }
    </style>
    {% if is_mobile %}
    <style>
        .host-container {
            padding: 10px;
            max-width: 100%;
        }
        .quiz-btn {
            font-size: 18px;
            padding: 12px 15px;
            min-width: 100px;
        }
        .game-code {
            font-size: 20px;
        }
        h1 {
            font-size: 24px;
        }
        .player-list li {
            font-size: 16px;
        }
        #question {
            font-size: 18px;
        }
    </style>
    {% endif %}
    <style>
        @media (max-width: 768px) {
            .host-container {
                padding: 15px;
                max-width: 100%;
            }
            h1 {
                font-size: 24px;
            }
            .game-code {
                font-size: 18px;
            }
            .player-list li {
                font-size: 16px;
            }
            .question-display {
                padding: 15px;
            }
            .question-text {
                font-size: 18px;
            }
            .btn-container {
                flex-direction: column;
            }
            .quiz-btn {
                margin: 5px 0;
                font-size: 16px;
                padding: 12px;
            }
            .leaderboard ol {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div style="position: fixed; top: 10px; right: 10px; display: flex; gap: 10px; align-items: center; z-index: 1000;">
        <a href="{{ url_for('home') }}" style="background: green; color: white; padding: 10px 15px; text-decoration: none; border-radius: 5px;">Home</a>
        <img src="/data/icon.png" alt="QuizFabric" style="height: 40px; width: 40px; opacity: 0.9;">
    </div>
    <div class="host-container">
        <h1>QuizFabric - {{ quiz_name }}</h1>
        <p>Game Code: <span class="game-code">{{ code }}</span></p>
        <p>Control Code: <button id="toggle-control-code">Show Control Code</button></p>
        <div id="control-code-display" style="display:none;">Control Code: <span id="control-code">{{ control_code }}</span></div>
        <p>Players Joined: <span id="player-count">0</span></p>
        <div id="qr-code" style="margin: 20px 0;">
            <h3>QR Code</h3>
            <img src="https://lucgei231.github.io/PythonServer/1.0/data/qr.png" alt="QR Code" style="max-width: 200px;">
        </div>
        <div id="player-list-container" class="player-list">
            <h3>Players:</h3>
            <ul id="player-list"></ul>
        </div>
        <div class="settings">
            <label><input type="checkbox" id="autoplay"> Autoplay (auto-advance leaderboard in 5s)</label>
        </div>
        <div id="question-display" style="display:none;">
            <h3>Question:</h3>
            <p id="question"></p>
            <div id="question-image" style="display:none; text-align:center; margin: 1rem 0;"></div>
            <p id="correct-answer" style="display:none;">Correct Answer: <span id="correct-answer-text"></span></p>
            <div class="btn-container">
                <button id="start-round" class="quiz-btn">Next Question</button>
                <button id="reveal-answers" class="quiz-btn" style="background-color: #28a745; display:none;">Skip</button>
            </div>
        </div>
        <div id="leaderboard" style="display:none;">
            <h3>Leaderboard</h3>
            <div id="points-display" style="display:none; text-align: center; padding: 15px; background: #f0f0f0; border-radius: 5px; margin-bottom: 15px;">
                <div style="font-size: 1.1em; margin-bottom: 10px;">
                    <strong>Points This Question: <span id="question-points" style="color: #28a745;">-</span></strong>
                </div>
                <hr style="margin: 10px 0; border: 1px solid #ddd;">
                <div style="font-size: 1.1em;">
                    <strong>Leader: <span id="leader-name" style="color: #007bff;">-</span> with <span id="leader-score" style="color: #007bff;">0</span> points</strong>
                </div>
            </div>
            <p id="leaderboard-correct-answer" style="display:none;">Correct answer was: <span id="leaderboard-correct-answer-text"></span></p>
            <p id="countdown" style="display:none;">Next question in: <span id="countdown-number">5</span></p>
            <ol id="leaderboard-list" style="font-size: 1.5em;"></ol>
            <div class="btn-container">
                <button id="next-question" class="quiz-btn">Next Question</button>
            </div>
        </div>
        <div id="final-leaderboard" style="display:none;">
            <h3>Final Leaderboard</h3>
            <ol id="final-leaderboard-list" style="font-size: 1.5em;"></ol>
        </div>
        <div class="btn-container">
            <button id="start-game" class="quiz-btn">Start Game</button>
        </div>
    </div>

    <script>
        const socket = io();
        const code = '{{ code }}';
        let players = [];
        let gameStarted = false;

        socket.on('connect', () => {
            socket.emit('host_join', {code: code});
        });

        socket.on('player_joined', (data) => {
            players.push(data.name);
            document.getElementById('player-count').textContent = players.length;
            updatePlayerList();
        });

        socket.on('player_left', (data) => {
            const playerName = data.name;
            players = players.filter(name => name !== playerName);
            document.getElementById('player-count').textContent = players.length;
            updatePlayerList();
        });

        document.getElementById('start-game').addEventListener('click', () => {
            gameStarted = true;
            document.getElementById('start-game').style.display = 'none';
            document.getElementById('qr-code').style.display = 'none';
            const playerListContainer = document.getElementById('player-list-container');
            playerListContainer.style.display = 'none';
            playerListContainer.classList.add('hidden');
            socket.emit('start_round', {code: code});
        });

        document.getElementById('toggle-control-code').addEventListener('click', () => {
            const display = document.getElementById('control-code-display');
            const button = document.getElementById('toggle-control-code');
            if (display.style.display === 'none') {
                display.style.display = 'block';
                button.textContent = 'Hide Control Code';
            } else {
                display.style.display = 'none';
                button.textContent = 'Show Control Code';
            }
        });

        document.getElementById('start-round').addEventListener('click', () => {
            document.getElementById('reveal-answers').style.display = 'none';
            socket.emit('start_round', {code: code});
        });

        document.getElementById('reveal-answers').addEventListener('click', () => {
            socket.emit('reveal_answers', {code: code});
        });

        socket.on('new_question', (data) => {
            document.getElementById('question-display').style.display = 'block';
            document.getElementById('question').textContent = data.question;
            // Show image if provided
            const qImgDiv = document.getElementById('question-image');
            if (data.images && data.images.length > 0) {
                qImgDiv.innerHTML = '';
                data.images.forEach(src => {
                    const img = document.createElement('img');
                    img.src = src;
                    img.style.maxWidth = '90%';
                    img.style.maxHeight = '60vh';
                    img.style.objectFit = 'contain';
                    img.style.borderRadius = '8px';
                    img.style.boxShadow = '0 6px 20px rgba(0,0,0,0.2)';
                    img.style.margin = '0.5rem';
                    qImgDiv.appendChild(img);
                });
                qImgDiv.style.display = 'block';
            } else {
                qImgDiv.style.display = 'none';
                qImgDiv.innerHTML = '';
            }
            document.getElementById('correct-answer').style.display = 'none';
            document.getElementById('reveal-answers').style.display = 'none';
        });

        socket.on('answer_received', (data) => {
            document.getElementById('reveal-answers').style.display = 'inline-block';
        });

        socket.on('answers_revealed', (data) => {
            document.getElementById('correct-answer-text').textContent = data.correct_answer;
            document.getElementById('correct-answer').style.display = 'block';
        });

        socket.on('leaderboard', (data) => {
            document.getElementById('question-display').style.display = 'none';
            document.getElementById('leaderboard').style.display = 'block';
            
            // Show top player info
            if (data.leaderboard.length > 0) {
                const topPlayer = data.leaderboard[0];
                document.getElementById('leader-name').textContent = topPlayer.name;
                document.getElementById('leader-score').textContent = topPlayer.score;
                
                // Calculate points earned this question (assuming previous state)
                const maxPoints = data.leaderboard.reduce((max, item) => Math.max(max, item.score), 0);
                if (data.leaderboard.length > 1) {
                    const secondPlayer = data.leaderboard[1];
                    const pointsThisQ = topPlayer.score - secondPlayer.score;
                    document.getElementById('question-points').textContent = Math.max(0, pointsThisQ);
                } else {
                    document.getElementById('question-points').textContent = topPlayer.score;
                }
                document.getElementById('points-display').style.display = 'block';
            }
            
            const ul = document.getElementById('leaderboard-list');
            ul.innerHTML = '';
            data.leaderboard.forEach((item, index) => {
                const li = document.createElement('li');
                const status = item.last_correct === null ? 'No answer' : item.last_correct ? 'Correct' : 'Incorrect';
                const submitted = data.submitted_answers ? data.submitted_answers[item.name] || 'N/A' : 'N/A';
                
                // Create container for avatar and text
                const container = document.createElement('div');
                container.style.display = 'flex';
                container.style.alignItems = 'center';
                container.style.gap = '10px';
                
                // Add avatar image if exists
                if (item.avatar) {
                    const img = document.createElement('img');
                    img.src = `/data/avatars/${item.avatar}.png`;
                    img.style.height = '1.2em';
                    img.style.width = '1.2em';
                    img.style.objectFit = 'contain';
                    img.onerror = () => { img.textContent = '●'; };
                    container.appendChild(img);
                }
                
                // Add text
                const text = document.createElement('span');
                text.innerHTML = `${item.name}: <span style="color: red;">${item.score}</span> points (${status}) - Answered: ${submitted}`;
                container.appendChild(text);
                li.appendChild(container);
                ul.appendChild(li);
            });
            document.getElementById('leaderboard-correct-answer-text').textContent = data.correct_answer;
            document.getElementById('leaderboard-correct-answer').style.display = 'block';
            
            // Autoplay countdown
            if (document.getElementById('autoplay').checked) {
                let count = 5;
                const countdownEl = document.getElementById('countdown-number');
                const countdownDiv = document.getElementById('countdown');
                countdownDiv.style.display = 'block';
                countdownEl.textContent = count;
                
                const interval = setInterval(() => {
                    count--;
                    if (count >= 0) {
                        countdownEl.textContent = count;
                    }
                    if (count < 0) {
                        clearInterval(interval);
                        countdownDiv.style.display = 'none';
                        document.getElementById('next-question').click();
                    }
                }, 1000);
            } else {
                document.getElementById('countdown').style.display = 'none';
            }
        });

        socket.on('final_leaderboard', (data) => {
            document.getElementById('leaderboard').style.display = 'none';
            document.getElementById('final-leaderboard').style.display = 'block';
            const ul = document.getElementById('final-leaderboard-list');
            ul.innerHTML = '';
            data.leaderboard.forEach((item, index) => {
                const li = document.createElement('li');
                
                // Create container for avatar and text
                const container = document.createElement('div');
                container.style.display = 'flex';
                container.style.alignItems = 'center';
                container.style.gap = '10px';
                
                // Add avatar image if exists
                if (item.avatar) {
                    const img = document.createElement('img');
                    img.src = `/data/avatars/${item.avatar}.png`;
                    img.style.height = '1.2em';
                    img.style.width = '1.2em';
                    img.style.objectFit = 'contain';
                    img.onerror = () => { img.textContent = '●'; };
                    container.appendChild(img);
                }
                
                // Add text
                const text = document.createElement('span');
                text.innerHTML = `${item.name}: <span style="color: red;">${item.score}</span> points`;
                container.appendChild(text);
                li.appendChild(container);
                ul.appendChild(li);
            });
        });

        document.getElementById('next-question').addEventListener('click', () => {
            document.getElementById('leaderboard').style.display = 'none';
            socket.emit('start_round', {code: code});
        });

        function updatePlayerList() {
            if (!gameStarted) {
                const ul = document.getElementById('player-list');
                ul.innerHTML = '';
                players.forEach(name => {
                    const li = document.createElement('li');
                    li.textContent = name;
                    ul.appendChild(li);
                });
            }
        }
    </script>
</body>
</html>