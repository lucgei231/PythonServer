<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Quiz: {{ quiz_name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        .host-container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        .game-code {
            font-size: 1.5em;
            font-weight: bold;
            color: #007bff;
        }
        .player-list {
            margin: 20px 0;
        }
        .answers-list {
            margin: 20px 0;
        }
        .btn-container {
            margin: 20px 0;
        }
    </style>
    {% if is_mobile %}
    <style>
        .host-container {
            padding: 10px;
            max-width: 100%;
        }
        .quiz-btn {
            font-size: 18px;
            padding: 12px 15px;
            min-width: 100px;
        }
        .game-code {
            font-size: 20px;
        }
        h1 {
            font-size: 24px;
        }
        .player-list li {
            font-size: 16px;
        }
        #question {
            font-size: 18px;
        }
    </style>
    {% endif %}
    <style>
        @media (max-width: 768px) {
            .host-container {
                padding: 15px;
                max-width: 100%;
            }
            h1 {
                font-size: 24px;
            }
            .game-code {
                font-size: 18px;
            }
            .player-list li {
                font-size: 16px;
            }
            .question-display {
                padding: 15px;
            }
            .question-text {
                font-size: 18px;
            }
            .btn-container {
                flex-direction: column;
            }
            .quiz-btn {
                margin: 5px 0;
                font-size: 16px;
                padding: 12px;
            }
            .leaderboard ol {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <a href="{{ url_for('home') }}" style="position: absolute; top: 10px; right: 10px; background: green; color: white; padding: 10px 15px; text-decoration: none; border-radius: 5px; z-index: 1000;">Home</a>
    <div class="host-container">
        <h1>Controlling Quiz: {{ quiz_name }}</h1>
        <p>Game Code: <span class="game-code">{{ code }}</span></p>
        <p>Players Joined: <span id="player-count">0</span></p>
        <div id="player-list-container" class="player-list">
            <h3>Players:</h3>
            <ul id="player-list"></ul>
        </div>
        <div class="settings">
            <label><input type="checkbox" id="autoplay"> Autoplay (auto-advance leaderboard in 5s)</label>
        </div>
        <div id="question-display" style="display:none;">
            <h3>Question:</h3>
            <p id="question"></p>
            <p id="correct-answer" style="display:none;">Correct Answer: <span id="correct-answer-text"></span></p>
            <div class="btn-container">
                <button id="start-round" class="quiz-btn">Next Question</button>
                <button id="reveal-answers" class="quiz-btn" style="background-color: #28a745; display:none;">Skip</button>
            </div>
        </div>
        <div id="leaderboard" style="display:none;">
            <h3>Leaderboard</h3>
            <div id="points-display" style="display:none; text-align: center; padding: 15px; background: #f0f0f0; border-radius: 5px; margin-bottom: 15px;">
                <div style="font-size: 1.1em; margin-bottom: 10px;">
                    <strong>Points This Question: <span id="question-points" style="color: #28a745;">-</span></strong>
                </div>
                <hr style="margin: 10px 0; border: 1px solid #ddd;">
                <div style="font-size: 1.1em;">
                    <strong>Leader: <span id="leader-name" style="color: #007bff;">-</span> with <span id="leader-score" style="color: #007bff;">0</span> points</strong>
                </div>
            </div>
            <p id="leaderboard-correct-answer" style="display:none;">Correct answer was: <span id="leaderboard-correct-answer-text"></span></p>
            <p id="countdown" style="display:none;">Next question in: <span id="countdown-number">5</span></p>
            <ol id="leaderboard-list" style="font-size: 1.5em;"></ol>
            <div class="btn-container">
                <button id="next-question" class="quiz-btn">Next Question</button>
            </div>
        </div>
        <div id="final-leaderboard" style="display:none;">
            <h3>Final Leaderboard</h3>
            <ol id="final-leaderboard-list" style="font-size: 1.5em;"></ol>
        </div>
        <div class="answers-list">
            <h3>Submitted Answers:</h3>
            <ul id="answer-list"></ul>
        </div>
        <div class="btn-container">
            <button id="start-game" class="quiz-btn">Start Game</button>
        </div>
    </div>

    <script>
        const socket = io();
        const code = '{{ code }}';
        let players = [];
        let answers = [];
        let gameStarted = false;

        socket.on('connect', () => {
            socket.emit('control_join', {code: code});
        });

        socket.on('player_joined', (data) => {
            players.push(data.name);
            document.getElementById('player-count').textContent = players.length;
            updatePlayerList();
        });

        socket.on('player_left', (data) => {
            const playerName = data.name;
            players = players.filter(name => name !== playerName);
            document.getElementById('player-count').textContent = players.length;
            updatePlayerList();
        });

        document.getElementById('start-game').addEventListener('click', () => {
            gameStarted = true;
            document.getElementById('start-game').style.display = 'none';
            socket.emit('start_round', {code: code});
        });

        document.getElementById('start-round').addEventListener('click', () => {
            answers = [];
            updateAnswerList();
            document.getElementById('reveal-answers').style.display = 'none';
            socket.emit('start_round', {code: code});
        });

        document.getElementById('reveal-answers').addEventListener('click', () => {
            socket.emit('reveal_answers', {code: code});
        });

        socket.on('answer_received', (data) => {
            answers.push(data);
            updateAnswerList();
            document.getElementById('reveal-answers').style.display = 'inline-block';
        });

        socket.on('new_question', (data) => {
            document.getElementById('question-display').style.display = 'block';
            document.getElementById('question').textContent = data.question;
            document.getElementById('correct-answer').style.display = 'none';
            answers = [];
            updateAnswerList();
            document.getElementById('reveal-answers').style.display = 'none';
        });

        socket.on('answers_revealed', (data) => {
            document.getElementById('correct-answer-text').textContent = data.correct_answer;
            document.getElementById('correct-answer').style.display = 'block';
        });

        socket.on('leaderboard', (data) => {
            document.getElementById('question-display').style.display = 'none';
            document.getElementById('leaderboard').style.display = 'block';
            
            // Show top player info
            if (data.leaderboard.length > 0) {
                const topPlayer = data.leaderboard[0];
                document.getElementById('leader-name').textContent = topPlayer.name;
                document.getElementById('leader-score').textContent = topPlayer.score;
                
                // Calculate points earned this question (assuming previous state)
                const maxPoints = data.leaderboard.reduce((max, item) => Math.max(max, item.score), 0);
                if (data.leaderboard.length > 1) {
                    const secondPlayer = data.leaderboard[1];
                    const pointsThisQ = topPlayer.score - secondPlayer.score;
                    document.getElementById('question-points').textContent = Math.max(0, pointsThisQ);
                } else {
                    document.getElementById('question-points').textContent = topPlayer.score;
                }
                document.getElementById('points-display').style.display = 'block';
            }
            
            const ul = document.getElementById('leaderboard-list');
            ul.innerHTML = '';
            data.leaderboard.forEach((item, index) => {
                const li = document.createElement('li');
                const status = item.last_correct === null ? 'No answer' : item.last_correct ? 'Correct' : 'Incorrect';
                const submitted = data.submitted_answers ? data.submitted_answers[item.name] || 'N/A' : 'N/A';
                
                // Create container for avatar and text
                const container = document.createElement('div');
                container.style.display = 'flex';
                container.style.alignItems = 'center';
                container.style.gap = '10px';
                
                // Add avatar image if exists
                if (item.avatar) {
                    const img = document.createElement('img');
                    img.src = `/data/avatars/${item.avatar}.png`;
                    img.style.height = '1.2em';
                    img.style.width = '1.2em';
                    img.style.objectFit = 'contain';
                    img.onerror = () => { img.textContent = '●'; };
                    container.appendChild(img);
                }
                
                // Add text
                const text = document.createElement('span');
                text.innerHTML = `${item.name}: <span style="color: red;">${item.score}</span> points (${status}) - Answered: ${submitted}`;
                container.appendChild(text);
                li.appendChild(container);
                ul.appendChild(li);
            });
            document.getElementById('leaderboard-correct-answer-text').textContent = data.correct_answer;
            document.getElementById('leaderboard-correct-answer').style.display = 'block';
            // Autoplay countdown
            if (document.getElementById('autoplay').checked) {
                let count = 5;
                const countdownEl = document.getElementById('countdown-number');
                document.getElementById('countdown').style.display = 'block';
                const interval = setInterval(() => {
                    countdownEl.textContent = count;
                    count--;
                    if (count < 0) {
                        clearInterval(interval);
                        document.getElementById('next-question').click();
                    }
                }, 1000);
            } else {
                document.getElementById('countdown').style.display = 'none';
            }
        });

        socket.on('final_leaderboard', (data) => {
            document.getElementById('leaderboard').style.display = 'none';
            document.getElementById('final-leaderboard').style.display = 'block';
            const ul = document.getElementById('final-leaderboard-list');
            ul.innerHTML = '';
            data.leaderboard.forEach((item, index) => {
                const li = document.createElement('li');
                
                // Create container for avatar and text
                const container = document.createElement('div');
                container.style.display = 'flex';
                container.style.alignItems = 'center';
                container.style.gap = '10px';
                
                // Add avatar image if exists
                if (item.avatar) {
                    const img = document.createElement('img');
                    img.src = `/data/avatars/${item.avatar}.png`;
                    img.style.height = '1.2em';
                    img.style.width = '1.2em';
                    img.style.objectFit = 'contain';
                    img.onerror = () => { img.textContent = '●'; };
                    container.appendChild(img);
                }
                
                // Add text
                const text = document.createElement('span');
                text.innerHTML = `${item.name}: <span style="color: red;">${item.score}</span> points`;
                container.appendChild(text);
                li.appendChild(container);
                ul.appendChild(li);
            });
        });

        document.getElementById('next-question').addEventListener('click', () => {
            document.getElementById('leaderboard').style.display = 'none';
            socket.emit('start_round', {code: code});
        });

        function updatePlayerList() {
            const ul = document.getElementById('player-list');
            ul.innerHTML = '';
            players.forEach(name => {
                const li = document.createElement('li');
                li.textContent = name;
                ul.appendChild(li);
            });
        }

        function updateAnswerList() {
            const ul = document.getElementById('answer-list');
            ul.innerHTML = '';
            answers.forEach(ans => {
                const li = document.createElement('li');
                li.textContent = `${ans.name}: ${ans.answer}`;
                ul.appendChild(li);
            });
        }
    </script>
</body>
</html>